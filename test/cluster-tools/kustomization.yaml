kind: Kustomization
apiVersion: kustomize.config.k8s.io/v1beta1

resources:
# These are AWS-specific and not included in the out-of-the-box cluster tools.
- ../../k8s-configs/cluster-tools/cert-manager/route53
- ../../k8s-configs/cluster-tools/cluster-autoscaler
- ../../k8s-configs/cluster-tools/monitoring/container-insights

# These are cloud-agnostic cluster tools.
- ../../k8s-configs/cluster-tools

patchesStrategicMerge:
- patches/clusterissuer/letsencrypt-issuer.yaml
- patches/certificate/acme-tls-cert.yaml
- patches/configmap/cluster-info.yaml
- patches/configmap/cwagentconfig.yaml

patchesJson6902:
# logs
- path: patches/ingress/logs.yaml
  target:
    group: extensions
    version: v1beta1
    kind: Ingress
    name: kibana-ingress
    namespace: elastic-stack-logging

# monitoring with grafana
- path: patches/ingress/grafana.yaml
  target:
    group: extensions
    version: v1beta1
    kind: Ingress
    name: grafana-ingress
    namespace: prometheus

# monitoring with prometheus
- path: patches/ingress/prometheus.yaml
  target:
    group: extensions
    version: v1beta1
    kind: Ingress
    name: prometheus-ingress
    namespace: prometheus

# cluster auto-scaler
- path: patches/deployment/patch-cluster-and-region.yaml
  target:
    group: apps
    version: v1
    kind: Deployment
    name: cluster-autoscaler
    namespace: kube-system

# Add the pingdirectory hostname to the private NLB for ldap access
# Also, make the admin nodes available externally for test purposes. In general, they
# will be behind a VPN gateway on all CDEs so only admins have access to them.
- path: patches/service/add-hostname-to-private-lb.yaml
  target:
    version: v1
    kind: Service
    name: ingress-nginx
    namespace: ingress-nginx-private

# Open up ports on the private NLB for PD LDAPS/replication and PF/PA admins
- path: patches/service/add-private-lb-port-mappings.yaml
  target:
    version: v1
    kind: Service
    name: ingress-nginx
    namespace: ingress-nginx-private

  # Configure the private nginx controller to receive traffic on the above ports
- path: patches/service/add-tcp-port-mappings.yaml
  target:
    version: v1
    kind: ConfigMap
    name: tcp-services
    namespace: ingress-nginx-private

# Add kube-dns hostname to the public NLB for service discovery across clusters
- path: patches/service/add-hostname-to-public-lb.yaml
  target:
    version: v1
    kind: Service
    name: ingress-nginx
    namespace: ingress-nginx-public

# Open up ports on the public NLB to expose kube-dns outside of the cluster
- path: patches/service/add-public-lb-port-mappings.yaml
  target:
    version: v1
    kind: Service
    name: ingress-nginx
    namespace: ingress-nginx-public

# Configure the public nginx controller to receive traffic on the above ports
- path: patches/service/add-udp-port-mappings.yaml
  target:
    version: v1
    kind: ConfigMap
    name: udp-services
    namespace: ingress-nginx-public

# Change the default TLS secret for the ingress controllers
- path: patches/deployment/nginx-controller.yaml
  target:
    group: apps
    version: v1
    kind: Deployment
    name: nginx-ingress-controller
    namespace: ingress-nginx-private

- path: patches/deployment/nginx-controller.yaml
  target:
    group: apps
    version: v1
    kind: Deployment
    name: nginx-ingress-controller
    namespace: ingress-nginx-public

# Change the namespace of the ACME certificate to the ping-cloud namespace
- path: patches/certificate/change-cert-namespace.yaml
  target:
    group: certmanager.k8s.io
    version: v1alpha1
    kind: Certificate
    name: acme-tls-cert
    namespace: cert-manager

# Configure external-dns to only own the hosted zone for the tenant domain
- path: patches/deployment/external-dns.yaml
  target:
    group: apps
    version: v1
    kind: Deployment
    name: external-dns
    namespace: external-dns