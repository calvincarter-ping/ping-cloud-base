apiVersion: v1
data:
  pds_conn_error.json: |-
    {
       "name": "PingDataSync Sync Resource Connection Error",
       "type": "monitor",
       "monitor_type": "bucket_level_monitor",
       "enabled": true,
       "schedule": {
          "period": {
             "unit": "MINUTES",
             "interval": 1
          }
       },
       "inputs": [
          {
             "search": {
                "indices": [
                   "pds-errors-*"
                ],
                "query": {
                   "size": 0,
                   "aggregations": {
                      "composite_agg": {
                         "composite": {
                            "sources": [
                               {
                                  "cluster_name": {
                                     "terms": {
                                        "field": "cluster_name.keyword"
                                     }
                                  }
                               }
                            ]
                         },
                         "aggs": {}
                      }
                   },
                   "query": {
                      "bool": {
                         "filter": [
                            {
                               "range": {
                                  "@timestamp": {
                                     "gte": "{{period_end}}||-90s",
                                     "lte": "{{period_end}}",
                                     "format": "epoch_millis"
                                  }
                               }
                            },
                            {
                              "match_phrase": {
                                "kubernetes.container_name": "pingdatasync"
                              }
                            },
                            {
                              "match_phrase": {
                                "msg": "\"sync-resource-connection-error\""
                              }
                            }
                         ]
                      }
                   }
                }
             }
          }
       ],
       "triggers": [
          {
             "bucket_level_trigger": {
                "name": "Count more than 1",
                "severity": "1",
                "condition": {
                   "buckets_path": {
                      "_count": "_count"
                   },
                   "parent_bucket_path": "composite_agg",
                   "script": {
                      "source": "params._count > 1",
                      "lang": "painless"
                   },
                   "gap_policy": "skip"
                },
                "actions": [
                  {
                        "name": "SREAPPALERTS",
                        "destination_id": "sns_sreappalerts",
                        "message_template": {
                          "source": "{\n  \"alert\": \"{{ctx.monitor.name}}\",\n  \"documents\": {{ctx.results.0.hits.total.value}},\n  \"cluster\": \"{{#ctx.newAlerts}}{{bucket_keys}}{{/ctx.newAlerts}}{{#ctx.dedupedAlerts}}{{bucket_keys}}{{/ctx.dedupedAlerts}}\",\n  \"timestamp\": \"{{ctx.periodEnd}}\",\n  \"runbook\": \"https://pingidentity.atlassian.net/wiki/spaces/ST/pages/154796163/ALERT+PingDataSync+Sync+Resource+Connection+Error+in+CDE\"\n}",
                          "lang": "mustache"
                        },
                        "throttle_enabled": false,
                        "subject_template": {
                          "source": "ALERT: {{ctx.monitor.name}}",
                          "lang": "mustache"
                        },
                        "action_execution_policy": {
                          "action_execution_scope": {
                            "per_alert": {
                              "actionable_alerts": [
                                "DEDUPED",
                                "NEW"
                              ]
                            }
                          }
                        }
                      },
                   {
                        "name": "CUSTOMERHUB",
                        "destination_id": "sns_customerhub",
                        "message_template": {
                          "source": "{\n  \"alert\": \"{{ctx.monitor.name}}\",\n  \"documents\": {{ctx.results.0.hits.total.value}},\n  \"cluster\": \"{{#ctx.newAlerts}}{{bucket_keys}}{{/ctx.newAlerts}}{{#ctx.dedupedAlerts}}{{bucket_keys}}{{/ctx.dedupedAlerts}}\",\n  \"timestamp\": \"{{ctx.periodEnd}}\",\n  \"runbook\": \"https://pingidentity.atlassian.net/wiki/spaces/ST/pages/154796163/ALERT+PingDataSync+Sync+Resource+Connection+Error+in+CDE\"\n}",
                          "lang": "mustache"
                        },
                        "throttle_enabled": false,
                        "subject_template": {
                          "source": "ALERT: {{ctx.monitor.name}}",
                          "lang": "mustache"
                        },
                        "action_execution_policy": {
                          "action_execution_scope": {
                            "per_alert": {
                              "actionable_alerts": [
                                "DEDUPED",
                                "NEW"
                              ]
                            }
                          }
                        }
                      }
                  ]
             }
          }
       ]
    }
  pds_ops_error.json: |-
    {
       "name": "PingDataSync Sync Resource Operation Error",
       "type": "monitor",
       "monitor_type": "bucket_level_monitor",
       "enabled": true,
       "schedule": {
          "period": {
             "unit": "MINUTES",
             "interval": 1
          }
       },
       "inputs": [
          {
             "search": {
                "indices": [
                   "pds-errors-*"
                ],
                "query": {
                   "size": 0,
                   "aggregations": {
                      "composite_agg": {
                         "composite": {
                            "sources": [
                               {
                                  "cluster_name": {
                                     "terms": {
                                        "field": "cluster_name.keyword"
                                     }
                                  }
                               }
                            ]
                         },
                         "aggs": {}
                      }
                   },
                   "query": {
                      "bool": {
                         "filter": [
                            {
                               "range": {
                                  "@timestamp": {
                                     "gte": "{{period_end}}||-90s",
                                     "lte": "{{period_end}}",
                                     "format": "epoch_millis"
                                  }
                               }
                            },
                            {
                              "match_phrase": {
                                "kubernetes.container_name": "pingdatasync"
                              }
                            },
                            {
                              "match_phrase": {
                                "msg": "\"sync-resource-operation-error\""
                              }
                            }
                         ]
                      }
                   }
                }
             }
          }
       ],
       "triggers": [
          {
             "bucket_level_trigger": {
                "name": "Count more than 0",
                "severity": "1",
                "condition": {
                   "buckets_path": {
                      "_count": "_count"
                   },
                   "parent_bucket_path": "composite_agg",
                   "script": {
                      "source": "params._count > 0",
                      "lang": "painless"
                   },
                   "gap_policy": "skip"
                },
                "actions": [
                  {
                        "name": "SREAPPALERTS",
                        "destination_id": "sns_sreappalerts",
                        "message_template": {
                          "source": "{\n  \"alert\": \"{{ctx.monitor.name}}\",\n  \"documents\": {{ctx.results.0.hits.total.value}},\n  \"cluster\": \"{{#ctx.newAlerts}}{{bucket_keys}}{{/ctx.newAlerts}}{{#ctx.dedupedAlerts}}{{bucket_keys}}{{/ctx.dedupedAlerts}}\",\n  \"timestamp\": \"{{ctx.periodEnd}}\",\n  \"runbook\": \"https://pingidentity.atlassian.net/wiki/spaces/ST/pages/154992777/ALERT+PingDataSync+Sync+Resource+Operation+Error+in+CDE\"\n}",
                          "lang": "mustache"
                        },
                        "throttle_enabled": false,
                        "subject_template": {
                          "source": "ALERT: {{ctx.monitor.name}}",
                          "lang": "mustache"
                        },
                        "action_execution_policy": {
                          "action_execution_scope": {
                            "per_alert": {
                              "actionable_alerts": [
                                "DEDUPED",
                                "NEW"
                              ]
                            }
                          }
                        }
                      },
                   {
                        "name": "CUSTOMERHUB",
                        "destination_id": "sns_customerhub",
                        "message_template": {
                          "source": "{\n  \"alert\": \"{{ctx.monitor.name}}\",\n  \"documents\": {{ctx.results.0.hits.total.value}},\n  \"cluster\": \"{{#ctx.newAlerts}}{{bucket_keys}}{{/ctx.newAlerts}}{{#ctx.dedupedAlerts}}{{bucket_keys}}{{/ctx.dedupedAlerts}}\",\n  \"timestamp\": \"{{ctx.periodEnd}}\",\n  \"runbook\": \"https://pingidentity.atlassian.net/wiki/spaces/ST/pages/154992777/ALERT+PingDataSync+Sync+Resource+Operation+Error+in+CDE\"\n}",
                          "lang": "mustache"
                        },
                        "throttle_enabled": false,
                        "subject_template": {
                          "source": "ALERT: {{ctx.monitor.name}}",
                          "lang": "mustache"
                        },
                        "action_execution_policy": {
                          "action_execution_scope": {
                            "per_alert": {
                              "actionable_alerts": [
                                "DEDUPED",
                                "NEW"
                              ]
                            }
                          }
                        }
                      }
                  ]
             }
          }
       ]
    }
  pds_pipe_backlog.json: |-
    {
       "name": "PingDataSync Sync Pipe Backlog Above Threshold",
       "type": "monitor",
       "monitor_type": "bucket_level_monitor",
       "enabled": true,
       "schedule": {
          "period": {
             "unit": "MINUTES",
             "interval": 1
          }
       },
       "inputs": [
          {
             "search": {
                "indices": [
                   "pds-errors-*"
                ],
                "query": {
                   "size": 0,
                   "aggregations": {
                      "composite_agg": {
                         "composite": {
                            "sources": [
                               {
                                  "cluster_name": {
                                     "terms": {
                                        "field": "cluster_name.keyword"
                                     }
                                  }
                               }
                            ]
                         },
                         "aggs": {}
                      }
                   },
                   "query": {
                      "bool": {
                         "filter": [
                            {
                               "range": {
                                  "@timestamp": {
                                     "gte": "{{period_end}}||-90s",
                                     "lte": "{{period_end}}",
                                     "format": "epoch_millis"
                                  }
                               }
                            },
                            {
                              "match_phrase": {
                                "kubernetes.container_name": "pingdatasync"
                              }
                            },
                            {
                              "match_phrase": {
                                "msg": "\"sync-pipe-backlog-above-threshold\""
                              }
                            }
                         ]
                      }
                   }
                }
             }
          }
       ],
       "triggers": [
          {
             "bucket_level_trigger": {
                "name": "Count more than 0",
                "severity": "1",
                "condition": {
                   "buckets_path": {
                      "_count": "_count"
                   },
                   "parent_bucket_path": "composite_agg",
                   "script": {
                      "source": "params._count > 0",
                      "lang": "painless"
                   },
                   "gap_policy": "skip"
                },
                "actions": [
                  {
                        "name": "SREAPPALERTS",
                        "destination_id": "sns_sreappalerts",
                        "message_template": {
                          "source": "{\n  \"alert\": \"{{ctx.monitor.name}}\",\n  \"documents\": {{ctx.results.0.hits.total.value}},\n  \"cluster\": \"{{#ctx.newAlerts}}{{bucket_keys}}{{/ctx.newAlerts}}{{#ctx.dedupedAlerts}}{{bucket_keys}}{{/ctx.dedupedAlerts}}\",\n  \"timestamp\": \"{{ctx.periodEnd}}\",\n  \"runbook\": \"https://pingidentity.atlassian.net/wiki/spaces/ST/pages/154796171/ALERT+PingDataSync+Sync+Pipe+Backlog+Above+Threshold+in+CDE\"\n}",
                          "lang": "mustache"
                        },
                        "throttle_enabled": false,
                        "subject_template": {
                          "source": "ALERT: {{ctx.monitor.name}}",
                          "lang": "mustache"
                        },
                        "action_execution_policy": {
                          "action_execution_scope": {
                            "per_alert": {
                              "actionable_alerts": [
                                "DEDUPED",
                                "NEW"
                              ]
                            }
                          }
                        }
                      },
                   {
                        "name": "CUSTOMERHUB",
                        "destination_id": "sns_customerhub",
                        "message_template": {
                          "source": "{\n  \"alert\": \"{{ctx.monitor.name}}\",\n  \"documents\": {{ctx.results.0.hits.total.value}},\n  \"cluster\": \"{{#ctx.newAlerts}}{{bucket_keys}}{{/ctx.newAlerts}}{{#ctx.dedupedAlerts}}{{bucket_keys}}{{/ctx.dedupedAlerts}}\",\n  \"timestamp\": \"{{ctx.periodEnd}}\",\n  \"runbook\": \"https://pingidentity.atlassian.net/wiki/spaces/ST/pages/154796171/ALERT+PingDataSync+Sync+Pipe+Backlog+Above+Threshold+in+CDE\"\n}",
                          "lang": "mustache"
                        },
                        "throttle_enabled": false,
                        "subject_template": {
                          "source": "ALERT: {{ctx.monitor.name}}",
                          "lang": "mustache"
                        },
                        "action_execution_policy": {
                          "action_execution_scope": {
                            "per_alert": {
                              "actionable_alerts": [
                                "DEDUPED",
                                "NEW"
                              ]
                            }
                          }
                        }
                      }
                  ]
             }
          }
       ]
    }
  pds_user_err.json: |-
    {
       "name": "PingDataSync User-defined Error",
       "type": "monitor",
       "monitor_type": "bucket_level_monitor",
       "enabled": true,
       "schedule": {
          "period": {
             "unit": "MINUTES",
             "interval": 1
          }
       },
       "inputs": [
          {
             "search": {
                "indices": [
                   "pds-errors-*"
                ],
                "query": {
                   "size": 0,
                   "aggregations": {
                      "composite_agg": {
                         "composite": {
                            "sources": [
                               {
                                  "cluster_name": {
                                     "terms": {
                                        "field": "cluster_name.keyword"
                                     }
                                  }
                               }
                            ]
                         },
                         "aggs": {}
                      }
                   },
                   "query": {
                      "bool": {
                         "filter": [
                            {
                               "range": {
                                  "@timestamp": {
                                     "gte": "{{period_end}}||-90s",
                                     "lte": "{{period_end}}",
                                     "format": "epoch_millis"
                                  }
                               }
                            },
                            {
                              "match_phrase": {
                                "kubernetes.container_name": "pingdatasync"
                              }
                            },
                            {
                              "match_phrase": {
                                "msg": "\"user-defined-error\""
                              }
                            }
                         ]
                      }
                   }
                }
             }
          }
       ],
       "triggers": [
          {
             "bucket_level_trigger": {
                "name": "Count more than 0",
                "severity": "1",
                "condition": {
                   "buckets_path": {
                      "_count": "_count"
                   },
                   "parent_bucket_path": "composite_agg",
                   "script": {
                      "source": "params._count > 0",
                      "lang": "painless"
                   },
                   "gap_policy": "skip"
                },
                "actions": [
                  {
                        "name": "SREAPPALERTS",
                        "destination_id": "sns_sreappalerts",
                        "message_template": {
                          "source": "{\n  \"alert\": \"{{ctx.monitor.name}}\",\n  \"documents\": {{ctx.results.0.hits.total.value}},\n  \"cluster\": \"{{#ctx.newAlerts}}{{bucket_keys}}{{/ctx.newAlerts}}{{#ctx.dedupedAlerts}}{{bucket_keys}}{{/ctx.dedupedAlerts}}\",\n  \"timestamp\": \"{{ctx.periodEnd}}\",\n  \"runbook\": \"https://pingidentity.atlassian.net/wiki/spaces/ST/pages/154796187/ALERT+PingDataSync+User-defined+Error+in+CDE\"\n}",
                          "lang": "mustache"
                        },
                        "throttle_enabled": false,
                        "subject_template": {
                          "source": "ALERT: {{ctx.monitor.name}}",
                          "lang": "mustache"
                        },
                        "action_execution_policy": {
                          "action_execution_scope": {
                            "per_alert": {
                              "actionable_alerts": [
                                "DEDUPED",
                                "NEW"
                              ]
                            }
                          }
                        }
                      },
                   {
                        "name": "CUSTOMERHUB",
                        "destination_id": "sns_customerhub",
                        "message_template": {
                          "source": "{\n  \"alert\": \"{{ctx.monitor.name}}\",\n  \"documents\": {{ctx.results.0.hits.total.value}},\n  \"cluster\": \"{{#ctx.newAlerts}}{{bucket_keys}}{{/ctx.newAlerts}}{{#ctx.dedupedAlerts}}{{bucket_keys}}{{/ctx.dedupedAlerts}}\",\n  \"timestamp\": \"{{ctx.periodEnd}}\",\n  \"runbook\": \"https://pingidentity.atlassian.net/wiki/spaces/ST/pages/154796187/ALERT+PingDataSync+User-defined+Error+in+CDE\"\n}",
                          "lang": "mustache"
                        },
                        "throttle_enabled": false,
                        "subject_template": {
                          "source": "ALERT: {{ctx.monitor.name}}",
                          "lang": "mustache"
                        },
                        "action_execution_policy": {
                          "action_execution_scope": {
                            "per_alert": {
                              "actionable_alerts": [
                                "DEDUPED",
                                "NEW"
                              ]
                            }
                          }
                        }
                      }
                  ]
             }
          }
       ]
    }
  pds_user_fatal.json: |-
    {
       "name": "PingDataSync User-defined Fatal",
       "type": "monitor",
       "monitor_type": "bucket_level_monitor",
       "enabled": true,
       "schedule": {
          "period": {
             "unit": "MINUTES",
             "interval": 1
          }
       },
       "inputs": [
          {
             "search": {
                "indices": [
                   "pds-errors-*"
                ],
                "query": {
                   "size": 0,
                   "aggregations": {
                      "composite_agg": {
                         "composite": {
                            "sources": [
                               {
                                  "cluster_name": {
                                     "terms": {
                                        "field": "cluster_name.keyword"
                                     }
                                  }
                               }
                            ]
                         },
                         "aggs": {}
                      }
                   },
                   "query": {
                      "bool": {
                         "filter": [
                            {
                               "range": {
                                  "@timestamp": {
                                     "gte": "{{period_end}}||-90s",
                                     "lte": "{{period_end}}",
                                     "format": "epoch_millis"
                                  }
                               }
                            },
                            {
                              "match_phrase": {
                                "kubernetes.container_name": "pingdatasync"
                              }
                            },
                            {
                              "match_phrase": {
                                "msg": "\"user-defined-fatal\""
                              }
                            }
                         ]
                      }
                   }
                }
             }
          }
       ],
       "triggers": [
          {
             "bucket_level_trigger": {
                "name": "Count more than 0",
                "severity": "1",
                "condition": {
                   "buckets_path": {
                      "_count": "_count"
                   },
                   "parent_bucket_path": "composite_agg",
                   "script": {
                      "source": "params._count > 0",
                      "lang": "painless"
                   },
                   "gap_policy": "skip"
                },
                "actions": [
                  {
                        "name": "SREAPPALERTS",
                        "destination_id": "sns_sreappalerts",
                        "message_template": {
                          "source": "{\n  \"alert\": \"{{ctx.monitor.name}}\",\n  \"documents\": {{ctx.results.0.hits.total.value}},\n  \"cluster\": \"{{#ctx.newAlerts}}{{bucket_keys}}{{/ctx.newAlerts}}{{#ctx.dedupedAlerts}}{{bucket_keys}}{{/ctx.dedupedAlerts}}\",\n  \"timestamp\": \"{{ctx.periodEnd}}\",\n  \"runbook\": \"https://pingidentity.atlassian.net/wiki/spaces/ST/pages/154992785/ALERT+PingDataSync+User-defined+Fatal+in+CDE\"\n}",
                          "lang": "mustache"
                        },
                        "throttle_enabled": false,
                        "subject_template": {
                          "source": "ALERT: {{ctx.monitor.name}}",
                          "lang": "mustache"
                        },
                        "action_execution_policy": {
                          "action_execution_scope": {
                            "per_alert": {
                              "actionable_alerts": [
                                "DEDUPED",
                                "NEW"
                              ]
                            }
                          }
                        }
                      },
                   {
                        "name": "CUSTOMERHUB",
                        "destination_id": "sns_customerhub",
                        "message_template": {
                          "source": "{\n  \"alert\": \"{{ctx.monitor.name}}\",\n  \"documents\": {{ctx.results.0.hits.total.value}},\n  \"cluster\": \"{{#ctx.newAlerts}}{{bucket_keys}}{{/ctx.newAlerts}}{{#ctx.dedupedAlerts}}{{bucket_keys}}{{/ctx.dedupedAlerts}}\",\n  \"timestamp\": \"{{ctx.periodEnd}}\",\n  \"runbook\": \"https://pingidentity.atlassian.net/wiki/spaces/ST/pages/154992785/ALERT+PingDataSync+User-defined+Fatal+in+CDE\"\n}",
                          "lang": "mustache"
                        },
                        "throttle_enabled": false,
                        "subject_template": {
                          "source": "ALERT: {{ctx.monitor.name}}",
                          "lang": "mustache"
                        },
                        "action_execution_policy": {
                          "action_execution_scope": {
                            "per_alert": {
                              "actionable_alerts": [
                                "DEDUPED",
                                "NEW"
                              ]
                            }
                          }
                        }
                      }
                  ]
             }
          }
       ]
    }
  pds_work_queue_back.json: |-
    {
       "name": "PingDataSync Work Queue Backlogged",
       "type": "monitor",
       "monitor_type": "bucket_level_monitor",
       "enabled": true,
       "schedule": {
          "period": {
             "unit": "MINUTES",
             "interval": 1
          }
       },
       "inputs": [
          {
             "search": {
                "indices": [
                   "pds-errors-*"
                ],
                "query": {
                   "size": 0,
                   "aggregations": {
                      "composite_agg": {
                         "composite": {
                            "sources": [
                               {
                                  "cluster_name": {
                                     "terms": {
                                        "field": "cluster_name.keyword"
                                     }
                                  }
                               }
                            ]
                         },
                         "aggs": {}
                      }
                   },
                   "query": {
                      "bool": {
                         "filter": [
                            {
                               "range": {
                                  "@timestamp": {
                                     "gte": "{{period_end}}||-90s",
                                     "lte": "{{period_end}}",
                                     "format": "epoch_millis"
                                  }
                               }
                            },
                            {
                              "match_phrase": {
                                "kubernetes.container_name": "pingdatasync"
                              }
                            },
                            {
                              "match_phrase": {
                                "msg": "\"work-queue-backlogged\""
                              }
                            }
                         ]
                      }
                   }
                }
             }
          }
       ],
       "triggers": [
          {
             "bucket_level_trigger": {
                "name": "Count more than 0",
                "severity": "1",
                "condition": {
                   "buckets_path": {
                      "_count": "_count"
                   },
                   "parent_bucket_path": "composite_agg",
                   "script": {
                      "source": "params._count > 0",
                      "lang": "painless"
                   },
                   "gap_policy": "skip"
                },
                "actions": [
                  {
                        "name": "SREAPPALERTS",
                        "destination_id": "sns_sreappalerts",
                        "message_template": {
                          "source": "{\n  \"alert\": \"{{ctx.monitor.name}}\",\n  \"documents\": {{ctx.results.0.hits.total.value}},\n  \"cluster\": \"{{#ctx.newAlerts}}{{bucket_keys}}{{/ctx.newAlerts}}{{#ctx.dedupedAlerts}}{{bucket_keys}}{{/ctx.dedupedAlerts}}\",\n  \"timestamp\": \"{{ctx.periodEnd}}\",\n  \"runbook\": \"https://pingidentity.atlassian.net/wiki/spaces/ST/pages/154992793/ALERT+PingDataSync+Work+Queue+Backlogged+in+CDE\"\n}",
                          "lang": "mustache"
                        },
                        "throttle_enabled": false,
                        "subject_template": {
                          "source": "ALERT: {{ctx.monitor.name}}",
                          "lang": "mustache"
                        },
                        "action_execution_policy": {
                          "action_execution_scope": {
                            "per_alert": {
                              "actionable_alerts": [
                                "DEDUPED",
                                "NEW"
                              ]
                            }
                          }
                        }
                      },
                   {
                        "name": "CUSTOMERHUB",
                        "destination_id": "sns_customerhub",
                        "message_template": {
                          "source": "{\n  \"alert\": \"{{ctx.monitor.name}}\",\n  \"documents\": {{ctx.results.0.hits.total.value}},\n  \"cluster\": \"{{#ctx.newAlerts}}{{bucket_keys}}{{/ctx.newAlerts}}{{#ctx.dedupedAlerts}}{{bucket_keys}}{{/ctx.dedupedAlerts}}\",\n  \"timestamp\": \"{{ctx.periodEnd}}\",\n  \"runbook\": \"https://pingidentity.atlassian.net/wiki/spaces/ST/pages/154992793/ALERT+PingDataSync+Work+Queue+Backlogged+in+CDE\"\n}",
                          "lang": "mustache"
                        },
                        "throttle_enabled": false,
                        "subject_template": {
                          "source": "ALERT: {{ctx.monitor.name}}",
                          "lang": "mustache"
                        },
                        "action_execution_policy": {
                          "action_execution_scope": {
                            "per_alert": {
                              "actionable_alerts": [
                                "DEDUPED",
                                "NEW"
                              ]
                            }
                          }
                        }
                      }
                  ]
             }
          }
       ]
    }
  pds_work_queue_full.json: |-
    {
       "name": "PingDataSync Work Queue Full",
       "type": "monitor",
       "monitor_type": "bucket_level_monitor",
       "enabled": true,
       "schedule": {
          "period": {
             "unit": "MINUTES",
             "interval": 1
          }
       },
       "inputs": [
          {
             "search": {
                "indices": [
                   "pds-errors-*"
                ],
                "query": {
                   "size": 0,
                   "aggregations": {
                      "composite_agg": {
                         "composite": {
                            "sources": [
                               {
                                  "cluster_name": {
                                     "terms": {
                                        "field": "cluster_name.keyword"
                                     }
                                  }
                               }
                            ]
                         },
                         "aggs": {}
                      }
                   },
                   "query": {
                      "bool": {
                         "filter": [
                            {
                               "range": {
                                  "@timestamp": {
                                     "gte": "{{period_end}}||-90s",
                                     "lte": "{{period_end}}",
                                     "format": "epoch_millis"
                                  }
                               }
                            },
                            {
                              "match_phrase": {
                                "kubernetes.container_name": "pingdatasync"
                              }
                            },
                            {
                              "match_phrase": {
                                "msg": "\"work-queue-full\""
                              }
                            }
                         ]
                      }
                   }
                }
             }
          }
       ],
       "triggers": [
          {
             "bucket_level_trigger": {
                "name": "Count more than 0",
                "severity": "1",
                "condition": {
                   "buckets_path": {
                      "_count": "_count"
                   },
                   "parent_bucket_path": "composite_agg",
                   "script": {
                      "source": "params._count > 0",
                      "lang": "painless"
                   },
                   "gap_policy": "skip"
                },
                "actions": [
                  {
                        "name": "SREAPPALERTS",
                        "destination_id": "sns_sreappalerts",
                        "message_template": {
                          "source": "{\n  \"alert\": \"{{ctx.monitor.name}}\",\n  \"documents\": {{ctx.results.0.hits.total.value}},\n  \"cluster\": \"{{#ctx.newAlerts}}{{bucket_keys}}{{/ctx.newAlerts}}{{#ctx.dedupedAlerts}}{{bucket_keys}}{{/ctx.dedupedAlerts}}\",\n  \"timestamp\": \"{{ctx.periodEnd}}\",\n  \"runbook\": \"https://pingidentity.atlassian.net/wiki/spaces/ST/pages/154796195/ALERT+PingDataSync+Work+Queue+Full+in+CDE\"\n}",
                          "lang": "mustache"
                        },
                        "throttle_enabled": false,
                        "subject_template": {
                          "source": "ALERT: {{ctx.monitor.name}}",
                          "lang": "mustache"
                        },
                        "action_execution_policy": {
                          "action_execution_scope": {
                            "per_alert": {
                              "actionable_alerts": [
                                "DEDUPED",
                                "NEW"
                              ]
                            }
                          }
                        }
                      },
                   {
                        "name": "CUSTOMERHUB",
                        "destination_id": "sns_customerhub",
                        "message_template": {
                          "source": "{\n  \"alert\": \"{{ctx.monitor.name}}\",\n  \"documents\": {{ctx.results.0.hits.total.value}},\n  \"cluster\": \"{{#ctx.newAlerts}}{{bucket_keys}}{{/ctx.newAlerts}}{{#ctx.dedupedAlerts}}{{bucket_keys}}{{/ctx.dedupedAlerts}}\",\n  \"timestamp\": \"{{ctx.periodEnd}}\",\n  \"runbook\": \"https://pingidentity.atlassian.net/wiki/spaces/ST/pages/154796195/ALERT+PingDataSync+Work+Queue+Full+in+CDE\"\n}",
                          "lang": "mustache"
                        },
                        "throttle_enabled": false,
                        "subject_template": {
                          "source": "ALERT: {{ctx.monitor.name}}",
                          "lang": "mustache"
                        },
                        "action_execution_policy": {
                          "action_execution_scope": {
                            "per_alert": {
                              "actionable_alerts": [
                                "DEDUPED",
                                "NEW"
                              ]
                            }
                          }
                        }
                      }
                  ]
             }
          }
       ]
    }
kind: ConfigMap
metadata:
  name: os-alerts-pds
  namespace: elastic-stack-logging
