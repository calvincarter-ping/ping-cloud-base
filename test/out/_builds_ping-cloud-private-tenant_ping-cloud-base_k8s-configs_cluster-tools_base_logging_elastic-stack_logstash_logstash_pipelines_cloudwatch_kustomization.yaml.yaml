apiVersion: v1
data:
  cloudwatch.conf: "input {\n  http {\n    port => 8082\n    id => \"cw_in\"\n  }\n}\nfilter
    {\n\t### Remove unneeded fields came from fluent-bit\n  mutate {\n          remove_field
    => [ \"headers\",\"host\",\"date\"]\n      }\n\n  if [kubernetes] {\n  ### Add
    temp field to specify correct stream name\n    mutate {\n        add_field =>
    { \"[@metadata][stream_name]\" => \"%{[kubernetes][pod_name]}_%{[kubernetes][namespace_name]}_%{[kubernetes][container_name]}\"
    }\n      }\n  }\n### Add temp field to have the correct host value in log\n  if
    [private_ip] {\n    mutate {\n        add_field => { \"[@metadata][transf_host]\"
    => \"%{private_ip}\" }\n      }\n    mutate {\n        gsub => [ \"[@metadata][transf_host]\",
    \"\\.\", \"-\" ]\n        add_field => { \"host\" => \"ip-%{[@metadata][transf_host]}\"
    }\n      }\n  }      \n}\noutput {\n  if [kubernetes] {\n    awslogs {\n        region
    => \"${AWS_REGION}\"\n        log_group_name => \"/aws/containerinsights/${CW_CLUSTER_NAME}/application\"\n
    \       log_stream_name => \"%{[@metadata][stream_name]}\"\n        id => \"cw_app_out\"\n
    \     }\n  }\n  if [log_name] {\n    awslogs {\n        region => \"${AWS_REGION}\"\n
    \       log_group_name => \"/aws/containerinsights/${CW_CLUSTER_NAME}/host\"\n
    \       log_stream_name => \"%{log_name}-%{host}\"\n        id => \"cw_host_out\"\n
    \     }\n  }\n  if [systemd_unit] {\n    awslogs {\n        region => \"${AWS_REGION}\"\n
    \       log_group_name => \"/aws/containerinsights/${CW_CLUSTER_NAME}/dataplane\"\n
    \       log_stream_name => \"%{systemd_unit}-%{hostname}\"\n        id => \"cw_data_out\"\n
    \     }\n  }    \n}"
kind: ConfigMap
metadata:
  name: logstash-pipeline-cw-8chtm622kh
  namespace: elastic-stack-logging
