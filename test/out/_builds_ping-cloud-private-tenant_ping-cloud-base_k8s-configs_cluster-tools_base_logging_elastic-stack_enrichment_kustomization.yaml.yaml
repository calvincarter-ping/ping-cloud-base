apiVersion: v1
kind: ServiceAccount
metadata:
  labels:
    app: enrichment
  name: enrichment
  namespace: elastic-stack-logging
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  labels:
    app: enrichment
  name: enrichment
  namespace: elastic-stack-logging
rules:
- apiGroups:
  - ""
  resources:
  - configmaps
  verbs:
  - create
  - update
  - get
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  labels:
    app: enrichment
  name: enrichment
rules:
- apiGroups:
  - ""
  resources:
  - persistentvolumes
  verbs:
  - get
  - list
  - watch
  - create
  - delete
- apiGroups:
  - ""
  resources:
  - persistentvolumeclaims
  verbs:
  - get
  - list
  - watch
  - update
- apiGroups:
  - storage.k8s.io
  resources:
  - storageclasses
  verbs:
  - get
  - list
  - watch
  - create
- apiGroups:
  - ""
  resources:
  - events
  verbs:
  - create
  - update
  - patch
- apiGroups:
  - ""
  resources:
  - pods
  verbs:
  - create
  - update
  - watch
- apiGroups:
  - ""
  resources:
  - namespaces
  verbs:
  - create
  - update
  - watch
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  labels:
    app: enrichment
  name: enrichment
  namespace: elastic-stack-logging
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: enrichment
subjects:
- kind: ServiceAccount
  name: enrichment
  namespace: elastic-stack-logging
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: enrichment
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: enrichment
subjects:
- kind: ServiceAccount
  name: enrichment
  namespace: elastic-stack-logging
---
apiVersion: v1
data:
  AlienVaultIP.yml: |
    "": "YES"
  KnownCountries.yml: |
    "United States": "YES"
    "Canada": "YES"
  MaliciousCountries.yml: |
    "Turkey": "YES"
    "Iran": "YES"
    "Iraq": "YES"
    "North Korea": "YES"
    "Ukraine": "YES"
  TorNodes.yml: |
    "": "YES"
kind: ConfigMap
metadata:
  name: enrichment-cache
  namespace: elastic-stack-logging
---
apiVersion: v1
data:
  REGION: ${REGION}
  SERVICE_SSM_PATH_PREFIX: /pcpt/service
kind: ConfigMap
metadata:
  name: logging-bootstrap-environment-variables
  namespace: elastic-stack-logging
---
apiVersion: v1
data:
  logging-bootstrap-resources.yaml: |
    storage/efs/uri:
      kind: StorageClass
      name: efs
      template:
      values_container_key: efsId
      ssm_type: string
      ssm_path_prefix: SERVICE_SSM_PATH_PREFIX
    storage/raw-logs/uri:
      kind: ConfigMap
      name: s3-raw-logs-bucket
      template:
      values_container_key: bucketName
      ssm_type: string
      ssm_path_prefix: SERVICE_SSM_PATH_PREFIX
kind: ConfigMap
metadata:
  name: logging-bootstrap-resources
  namespace: elastic-stack-logging
---
apiVersion: batch/v1
kind: Job
metadata:
  annotations:
    argocd.argoproj.io/hook: Sync
    argocd.argoproj.io/hook-delete-policy: BeforeHookCreation
    argocd.argoproj.io/sync-options: Replace=true
  name: logging-bootstrap
  namespace: elastic-stack-logging
spec:
  template:
    spec:
      containers:
      - env:
        - name: NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        envFrom:
        - configMapRef:
            name: logging-bootstrap-environment-variables
        image: public.ecr.aws/r2h3l6e4/pingcloud-services/bootstrap/dev:v1.19-release-branch-latest
        imagePullPolicy: Always
        name: logging-bootstrap
        resources:
          limits:
            cpu: 500m
            memory: 512Mi
          requests:
            cpu: 300m
            memory: 256Mi
        securityContext:
          allowPrivilegeEscalation: false
          runAsGroup: 1000
          runAsNonRoot: true
          runAsUser: 1000
        volumeMounts:
        - mountPath: /app/config/app_config.yaml
          name: logging-bootstrap-resources
          readOnly: true
          subPath: logging-bootstrap-resources.yaml
      restartPolicy: OnFailure
      serviceAccountName: enrichment
      volumes:
      - configMap:
          name: logging-bootstrap-resources
        name: logging-bootstrap-resources
