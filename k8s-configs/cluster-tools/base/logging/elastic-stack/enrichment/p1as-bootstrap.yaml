apiVersion: batch/v1
kind: Job
metadata:
  name: p1as-bootstrap
  labels:
    role: p1as-bootstrap
spec:
  # 24-hour TTL for debugging
  ttlSecondsAfterFinished: 86400
  template:
    spec:
      serviceAccountName: p1as-bootstrap
      containers:
      - name: p1as-bootstrap
        securityContext:
          allowPrivilegeEscalation: false
          runAsGroup: 9999
          runAsNonRoot: true
          runAsUser: 9031
        image: public.ecr.aws/r2h3l6e4/pingcloud-services/bootstrap/dev:v1.19-release-branch-latest
        imagePullPolicy: Always
        env:
          - name: NAMESPACE
            valueFrom:
              fieldRef:
                fieldPath: metadata.namespace
        envFrom:
        - configMapRef:
            name: p1as-bootstrap
        volumeMounts:
          - mountPath: /app/config/app_config.yaml
            name: p1as-bootstrap-resources
            readOnly: true
            subPath: p1as-bootstrap-resources.yaml
        resources:
          requests:
            memory: "256Mi"
            cpu: "300m"
          limits:
            memory: "512Mi"
            cpu: "500m"
      restartPolicy: Never
      tolerations:
      - effect: NoSchedule
        key: CriticalAddonsOnly
        operator: Equal
        value: core
      volumes:
      - name: p1as-bootstrap-resources
        configMap:
          name: p1as-bootstrap-resources
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: p1as-bootstrap
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: p1as-bootstrap-resources
data:
  p1as-bootstrap-resources.yaml: |
    bootstrap-configuration:
      kind: Secret
      name: p14c-bootstrap-secret
      template: templates/p14c-bootstrap-secret.yaml
      values_container_key: bootstrapConfiguration
      ssm_type: json
      ssm_path_prefix: CUSTOMER_SSO_SSM_PATH_PREFIX
    environment-metadata:
      kind: ConfigMap
      name: p14c-environment-metadata
      template:
      values_container_key: information.json
      ssm_type: json
      ssm_path_prefix: CUSTOMER_SSO_SSM_PATH_PREFIX
    davinci-configuration:
      kind: Secret
      name: davinci-configuration
      template: templates/davinci-configuration.yaml
      values_container_key: davinciConfiguration
      ssm_type: json
      ssm_path_prefix: CUSTOMER_SSO_SSM_PATH_PREFIX
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: p1as-bootstrap
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: p1as-bootstrap-role
rules:
  - apiGroups:
    - ""
    resources:
    - "configmaps"
    verbs:
    - create
    - update
    - patch
    - get
    - list
  - apiGroups:
    - ""
    resources:
    - "secrets"
    verbs:
    - create
    - update
    - patch
    - get
    - list
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: p1as-bootstrap-rolebinding
subjects:
  - kind: ServiceAccount
    name: p1as-bootstrap
    namespace: elastic-stack-logging
roleRef:
  kind: Role
  name: p1as-bootstrap-role
  apiGroup: rbac.authorization.k8s.io