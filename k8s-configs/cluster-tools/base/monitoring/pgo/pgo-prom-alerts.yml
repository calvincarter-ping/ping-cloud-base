###
#
# Copyright 2017-2022 Crunchy Data Solutions, Inc. All Rights Reserved.
#
###
groups:
- name: pgo-alert-rules
  rules:

########## EXPORTER RULES ##########
  - alert: PGExporterScrapeError
    expr: pg_exporter_last_scrape_error > 0
    for: 60s
    labels:
      service: postgresql
      severity: critical
      severity_num: 300
    annotations:
      summary: 'Postgres Exporter running on {{ $labels.cluster }} (instance: {{ $labels.pod
        }}) is encountering scrape errors processing queries. Error count: ( {{ $value
        }} )'
  - alert: PGIsUp
    expr: pg_up < 1
    for: 60s
    labels:
      service: postgresql
      severity: critical
      severity_num: 300
    annotations:
      summary: postgres_exporter running on {{ $labels.pod }} is unable to communicate
        with the configured database
  - alert: PGIdleTxn
    expr: ccp_connection_stats_max_idle_in_txn_time > 300
    for: 60s
    labels:
      service: postgresql
      severity: warning
      severity_num: 200
    annotations:
      description: '{{ $labels.cluster }} has at least one session idle in transaction
        for over 5 minutes.'
      summary: PGSQL Instance idle transactions
  - alert: PGIdleTxn
    expr: ccp_connection_stats_max_idle_in_txn_time > 900
    for: 60s
    labels:
      service: postgresql
      severity: critical
      severity_num: 300
    annotations:
      description: '{{ $labels.cluster }} has at least one session idle in transaction
        for over 15 minutes.'
      summary: PGSQL Instance idle transactions
  - alert: PGQueryTime
    expr: ccp_connection_stats_max_query_time > 43200
    for: 60s
    labels:
      service: postgresql
      severity: warning
      severity_num: 200
    annotations:
      description: '{{ $labels.cluster }} has at least one query running for over
        12 hours.'
      summary: PGSQL Max Query Runtime
  - alert: PGQueryTime
    expr: ccp_connection_stats_max_query_time > 86400
    for: 60s
    labels:
      service: postgresql
      severity: critical
      severity_num: 300
    annotations:
      description: '{{ $labels.cluster }} has at least one query running for over
        1 day.'
      summary: PGSQL Max Query Runtime
  - alert: PGConnPerc
    expr: 100 * (ccp_connection_stats_total / ccp_connection_stats_max_connections)
      > 75
    for: 60s
    labels:
      service: postgresql
      severity: warning
      severity_num: 200
    annotations:
      description: '{{ $labels.cluster }} is using 75% or more of available connections
        ({{ $value }}%)'
      summary: PGSQL Instance connections
  - alert: PGConnPerc
    expr: 100 * (ccp_connection_stats_total / ccp_connection_stats_max_connections)
      > 90
    for: 60s
    labels:
      service: postgresql
      severity: critical
      severity_num: 300
    annotations:
      description: '{{ $labels.cluster }} is using 90% or more of available connections
        ({{ $value }}%)'
      summary: PGSQL Instance connections
  - alert: PGDiskSize
    expr: 100 * ((ccp_nodemx_data_disk_total_bytes - ccp_nodemx_data_disk_available_bytes)
      / ccp_nodemx_data_disk_total_bytes) > 75
    for: 60s
    labels:
      service: postgresql
      severity: warning
      severity_num: 200
    annotations:
      description: 'PGSQL Instance {{ $labels.deployment }} over 75% disk usage at
        mount point "{{ $labels.mount_point }}": {{ $value }}%'
      summary: PGSQL Instance usage warning
  - alert: PGDiskSize
    expr: 100 * ((ccp_nodemx_data_disk_total_bytes - ccp_nodemx_data_disk_available_bytes)
      / ccp_nodemx_data_disk_total_bytes) > 90
    for: 60s
    labels:
      service: postgresql
      severity: critical
      severity_num: 300
    annotations:
      description: 'PGSQL Instance {{ $labels.deployment }} over 90% disk usage at
        mount point "{{ $labels.mount_point }}": {{ $value }}%'
      summary: PGSQL Instance size critical
  - alert: PGReplicationByteLag
    expr: ccp_replication_status_byte_lag > 5.24288e+07
    for: 60s
    labels:
      service: postgresql
      severity: warning
      severity_num: 200
    annotations:
      description: PGSQL Instance {{ $labels.cluster }} has at least one replica lagging
        over 50MB behind.
      summary: PGSQL Instance replica lag warning
  - alert: PGReplicationByteLag
    expr: ccp_replication_status_byte_lag > 1.048576e+08
    for: 60s
    labels:
      service: postgresql
      severity: critical
      severity_num: 300
    annotations:
      description: PGSQL Instance {{ $labels.cluster }} has at least one replica lagging
        over 100MB behind.
      summary: PGSQL Instance replica lag warning
  - alert: PGReplicationSlotsInactive
    expr: ccp_replication_slots_active == 0
    for: 60s
    labels:
      service: postgresql
      severity: critical
      severity_num: 300
    annotations:
      description: PGSQL Instance {{ $labels.cluster }} has one or more inactive replication
        slots
      summary: PGSQL Instance inactive replication slot
  - alert: PGXIDWraparound
    expr: ccp_transaction_wraparound_percent_towards_wraparound > 50
    for: 60s
    labels:
      service: postgresql
      severity: warning
      severity_num: 200
    annotations:
      description: PGSQL Instance {{ $labels.cluster }} is over 50% towards transaction
        id wraparound.
      summary: PGSQL Instance {{ $labels.cluster }} transaction id wraparound imminent
  - alert: PGXIDWraparound
    expr: ccp_transaction_wraparound_percent_towards_wraparound > 75
    for: 60s
    labels:
      service: postgresql
      severity: critical
      severity_num: 300
    annotations:
      description: PGSQL Instance {{ $labels.cluster }} is over 75% towards transaction
        id wraparound.
      summary: PGSQL Instance transaction id wraparound imminent
  - alert: PGEmergencyVacuum
    expr: ccp_transaction_wraparound_percent_towards_emergency_autovac > 110
    for: 60s
    labels:
      service: postgresql
      severity: warning
      severity_num: 200
    annotations:
      description: PGSQL Instance {{ $labels.cluster }} is over 110% beyond autovacuum_freeze_max_age
        value. Autovacuum may need tuning to better keep up.
      summary: PGSQL Instance emergency vacuum imminent
  - alert: PGEmergencyVacuum
    expr: ccp_transaction_wraparound_percent_towards_emergency_autovac > 125
    for: 60s
    labels:
      service: postgresql
      severity: critical
      severity_num: 300
    annotations:
      description: PGSQL Instance {{ $labels.cluster }} is over 125% beyond autovacuum_freeze_max_age
        value. Autovacuum needs tuning to better keep up.
      summary: PGSQL Instance emergency vacuum imminent
  - alert: PGArchiveCommandStatus
    expr: ccp_archive_command_status_seconds_since_last_fail > 300
    for: 60s
    labels:
      service: postgresql
      severity: critical
      severity_num: 300
    annotations:
      description: PGSQL Instance {{ $labels.cluster }} has a recent failing archive
        command
      summary: Seconds since the last recorded failure of the archive_command
  - alert: PGSequenceExhaustion
    expr: ccp_sequence_exhaustion_count > 0
    for: 60s
    labels:
      service: postgresql
      severity: critical
      severity_num: 300
    annotations:
      description: 'Count of sequences on instance {{ $labels.cluster }} at over 75%
        usage: {{ $value }}. Run following query to see full sequence status: SELECT
        * FROM monitor.sequence_status() WHERE percent >= 75'
  - alert: PGSettingsPendingRestart
    expr: ccp_settings_pending_restart_count > 0
    for: 60s
    labels:
      service: postgresql
      severity: critical
      severity_num: 300
    annotations:
      description: One or more settings in the pg_settings system catalog on system
        {{ $labels.cluster }} are in a pending_restart state. Check the system catalog
        for which settings are pending and review postgresql.conf for changes.
  - alert: PGBackRestLastCompletedFull_main
    expr: ccp_backrest_last_full_backup_time_since_completion_seconds{stanza="db",
      role="master"} > 604800
    for: 60s
    labels:
      service: postgresql
      severity: critical
      severity_num: 300
    annotations:
      summary: Full backup for stanza [db] on cluster {{ $labels.cluster }} has not
        completed in the last week.
  - alert: PGBackRestLastCompletedIncr_main
    expr: ccp_backrest_last_incr_backup_time_since_completion_seconds{stanza="db",
      role="master"} > 86400
    for: 60s
    labels:
      service: postgresql
      severity: critical
      severity_num: 300
    annotations:
      summary: Incremental backup for stanza [db] on cluster {{ $labels.cluster }}
        has not completed in the last 24 hours.
  - alert: PGBackRestLastRuntimeDiff_main
    expr: ccp_backrest_last_runtime_backup_runtime_seconds{backup_type="diff", stanza="db",
      role="master"} > 3600
    for: 60s
    labels:
      service: postgresql
      severity: critical
      severity_num: 300
    annotations:
      summary: Expected runtime of diff backup for stanza [db] has exceeded 1 hour
  - alert: PGBackrestAbsentFull_Prod
    expr: absent(ccp_backrest_last_full_backup_time_since_completion_seconds{cluster="pf-provisioning",
      role="master"})
    for: 10s
    labels:
      service: postgresql
      severity: critical
      severity_num: 300
    annotations:
      summary: Full backup missing
      description: Backup Full status missing for pf-provisioning. Check that pgbackrest
        info command is working on target system.
