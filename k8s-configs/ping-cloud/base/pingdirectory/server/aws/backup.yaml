# A manual backup job - this does the same thing as the CronJob except it may be configured to be triggered in reaction
# to a ClickOps event.
apiVersion: batch/v1
kind: Job
metadata:
  name: pingdirectory-backup
  labels:
    app: ping-cloud
    role: pingdirectory
spec:
  ttlSecondsAfterFinished: 30
  backoffLimit: 5
  template:
    spec:
      serviceAccount: ping-serviceaccount
      affinity:
        # This podAffinity rule is designed to deploy PingDataSync to the same AZ as its targeted PingDirectory syncing server.
        # The default is set to deploy to the same AZ as "pingdirectory-0".
        podAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchExpressions:
              - key: statefulset.kubernetes.io/pod-name
                operator: In
                values:
                - pingdirectory-0
            topologyKey: "kubernetes.io/hostname"
      # this does not apply in dev/test and is removed via kustomize
      tolerations:
        - key: "pingidentity.com/pd-only"
          operator: "Equal"
          value: "true"
          effect: "NoSchedule"
      restartPolicy: Never
      containers:
      - name: pingdirectory-backup
        image: 705370621539.dkr.ecr.us-west-2.amazonaws.com/pingcloud-apps/pingdirectory:pdo-4959-1
        imagePullPolicy: Always
        securityContext:
          runAsGroup: 9999
          runAsNonRoot: true
          runAsUser: 9031
          allowPrivilegeEscalation: false
        command:
        - /opt/in/backup.sh
        envFrom:
        - configMapRef:
            name: pingdirectory-environment-variables
        - configMapRef:
            name: pingcommon-environment-variables
        env:
        - name: LOG4J_FORMAT_MSG_NO_LOOKUPS
          value: "true"
        volumeMounts:
        - name: backup-script
          mountPath: /opt/in/backup.sh
          subPath: backup.sh
        - name: out-dir
          mountPath: /opt/out
        - name: pd-backup-volume
          mountPath: /opt/backup
        - name: pingdirectory-passwords
          mountPath: /usr/local/secrets
          readOnly: true
        - name: pingdirectory-init
          mountPath: /logger.lib.sh
          subPath: logger.lib.sh
      securityContext:
        fsGroup: 9999
      volumes:
      - name: backup-script
        configMap:
          name: pingdirectory-backup
          defaultMode: 0555
      - name: out-dir
        persistentVolumeClaim:
          claimName: out-dir-pingdirectory-0
      - name: pd-backup-volume
        persistentVolumeClaim:
          claimName: custom-of-pvc
      - name: pingdirectory-passwords
        secret:
          secretName: pingdirectory-passwords
          optional: true
          defaultMode: 0400
      - name: pingdirectory-init
        configMap:
          name: pingcommon-init
          defaultMode: 0555

---

# apiVersion: v1
# kind: PersistentVolumeClaim
# metadata:
#     name: clone-of-pvc
#     namespace: ping-cloud-calvincarter
# spec:
#   accessModes:
#   - ReadWriteOnce
#   storageClassName: pingdirectory-gp3
#   resources:
#     requests:
#       storage: 50Gi
#   dataSource:
#       name: ebs-volume-snapshot
#       kind: VolumeSnapshot
#       apiGroup: snapshot.storage.k8s.io

---

apiVersion: v1
kind: PersistentVolumeClaim
metadata:
    name: custom-of-pvc
    namespace: ping-cloud-calvincarter
spec:
  accessModes:
  - ReadWriteOnce
  storageClassName: pingdirectory-gp3
  resources:
    requests:
      storage: 30Gi