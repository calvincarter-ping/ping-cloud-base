apiVersion: v1
kind: ConfigMap
metadata:
  name: pingdirectory-export-ldif
data:
  export-ldif-data.sh: |-
    #!/bin/sh

    # Install kubectl
    curl -sS https://storage.googleapis.com/kubernetes-release/release/"${KUBECTL_VERSION}"/bin/linux/amd64/kubectl -o /tmp/kubectl
    chmod +x /tmp/kubectl

    LDIF_FILES=
    SERVER="${K8S_STATEFUL_SET_NAME}-1"
    SCRIPT="${HOOKS_DIR}"/90-export-ldif-s3.sh
    LOG_FILE=/tmp/upload.log

    echo "Uploading LDIF_FILES on server ${SERVER}"
    /tmp/kubectl exec "${SERVER}" -c pingdirectory -- sh -c "test -x ${SCRIPT} && ${SCRIPT}">"${LOG_FILE}"
    export_ldif_status=$?

    # Sending success/ or failure logs to STDOUT
    cat ${LOG_FILE}

    if test ${export_ldif_status} -ne 0; then
      echo "Script failed on server ${SERVER} exiting"
      exit 1
    fi